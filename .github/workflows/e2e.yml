name: E2E Tests - Playwright

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sociallab_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: sociallab_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Start backend server
        working-directory: ./backend
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo $! > backend.pid
          # Wait for backend to be ready
          timeout 60 bash -c 'until curl -s http://localhost:8000/health > /dev/null; do sleep 1; done'
        env:
          DATABASE_URL: postgresql://sociallab_test:test_password@localhost:5432/sociallab_test
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_TEST_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_TEST_API_KEY }}
          INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_TEST_APP_ID }}
          INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_TEST_APP_SECRET }}

      - name: Start frontend server
        working-directory: ./frontend
        run: |
          npm run build
          npx vite preview --port 3000 &
          echo $! > frontend.pid
          # Wait for frontend to be ready
          timeout 60 bash -c 'until curl -s http://localhost:3000 > /dev/null; do sleep 1; done'
        env:
          VITE_API_URL: http://localhost:8000

      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npx playwright test
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-videos
          path: frontend/test-results/
          retention-days: 7

      - name: Cleanup servers
        if: always()
        run: |
          if [ -f backend/backend.pid ]; then kill $(cat backend/backend.pid) || true; fi
          if [ -f frontend/frontend.pid ]; then kill $(cat frontend/frontend.pid) || true; fi

  visual-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: e2e-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Run visual regression tests
        working-directory: ./frontend
        run: npx playwright test --grep @visual
        continue-on-error: true

      - name: Upload visual diffs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-diffs
          path: frontend/test-results/
          retention-days: 7
